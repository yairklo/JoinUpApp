generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String          @id
  email          String?         @unique
  name           String?
  imageUrl       String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  birthYear      Int?
  city           String?
  phone          String?
  favoriteFields FavoriteField[]
  requestsRecv   FriendRequest[] @relation("Recv")
  requestsSent   FriendRequest[] @relation("Sent")
  friendshipsA   Friendship[]    @relation("A")
  friendshipsB   Friendship[]    @relation("B")
  organizedGames Game[]          @relation("OrganizerGames")
  participations Participation[]
  positions      UserPosition[]
  sports         UserSport[]
}

model Field {
  id           String          @id @default(cuid())
  name         String
  location     String
  description  String?
  price        Int             @default(0)
  rating       Float           @default(0)
  image        String?
  available    Boolean         @default(true)
  type         FieldType
  lat          Float?
  lng          Float?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  city         String?
  email        String?
  featuresJson Json?
  neighborhood String?
  phone        String?
  photos       String[]
  street       String?
  streetNumber String?
  favorites    FavoriteField[]
  games        Game[]
}

model Game {
  id           String          @id @default(cuid())
  fieldId      String
  start        DateTime
  duration     Int             @default(1)
  maxPlayers   Int
  isOpenToJoin Boolean         @default(true)
  // Visible only to organizer's friends and participants when true
  isFriendsOnly Boolean        @default(false)
  description  String?
  // Optional custom location for games not tied to a mapped field
  customLat    Float?
  customLng    Float?
  customLocation String?
  organizerId  String
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  field        Field           @relation(fields: [fieldId], references: [id])
  organizer    User            @relation("OrganizerGames", fields: [organizerId], references: [id])
  participants Participation[]
}

model Participation {
  id        String   @id @default(cuid())
  gameId    String
  userId    String
  createdAt DateTime @default(now())
  game      Game     @relation(fields: [gameId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([gameId, userId])
}

model Message {
  id        String   @id @default(cuid())
  roomId    String
  userId    String?
  text      String
  createdAt DateTime @default(now())
}

model FavoriteField {
  id      String @id @default(cuid())
  userId  String
  fieldId String
  field   Field  @relation(fields: [fieldId], references: [id])
  user    User   @relation(fields: [userId], references: [id])

  @@unique([userId, fieldId])
}

model Friendship {
  id        String   @id @default(cuid())
  userAId   String
  userBId   String
  createdAt DateTime @default(now())
  userA     User     @relation("A", fields: [userAId], references: [id])
  userB     User     @relation("B", fields: [userBId], references: [id])

  @@unique([userAId, userBId])
}

model FriendRequest {
  id          String              @id @default(cuid())
  requesterId String
  receiverId  String
  status      FriendRequestStatus @default(PENDING)
  createdAt   DateTime            @default(now())
  receiver    User                @relation("Recv", fields: [receiverId], references: [id])
  requester   User                @relation("Sent", fields: [requesterId], references: [id])

  @@unique([requesterId, receiverId])
}

model Sport {
  id        String      @id @default(cuid())
  name      String      @unique
  positions Position[]
  users     UserSport[]
}

model Position {
  id      String         @id @default(cuid())
  name    String
  sportId String
  sport   Sport          @relation(fields: [sportId], references: [id])
  users   UserPosition[]

  @@unique([sportId, name])
}

model UserSport {
  id      String @id @default(cuid())
  userId  String
  sportId String
  sport   Sport  @relation(fields: [sportId], references: [id])
  user    User   @relation(fields: [userId], references: [id])

  @@unique([userId, sportId])
}

model UserPosition {
  id         String   @id @default(cuid())
  userId     String
  positionId String
  position   Position @relation(fields: [positionId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, positionId])
}

enum FieldType {
  OPEN
  CLOSED
}

enum FriendRequestStatus {
  PENDING
  DECLINED
}
